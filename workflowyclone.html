<!doctype html>

<head>
  <title>Thoughtstreamer</title>
  <meta charset="utf-8"/>

  <link rel="stylesheet" href="externals/codemirror/lib/codemirror.css">
  <link rel="stylesheet" href="externals/codemirror/theme/monokai.css">
  <link rel="stylesheet" href="externals/codemirror/addon/fold/foldgutter.css" />
  <link rel="stylesheet" href="mode-thoughtstream.css" />
  <script src="externals/codemirror/lib/codemirror.js"></script>
  <script src="externals/codemirror/addon/fold/foldcode.js"></script>
  <script src="externals/codemirror/addon/fold/foldgutter.js"></script>
  <script src="externals/codemirror/addon/fold/markdown-fold.js"></script>
  <script src="externals/codemirror/addon/fold/indent-fold.js"></script>
  <script src="externals/codemirror/mode/markdown/markdown.js"></script>
  <script src="mode-thoughtstream.js"></script> 


  <script src="jquery-2.1.1.js"></script>

  <style type="text/css">
    html { height: 100%; }
    body { 
      margin: 0; padding: 0; height: 100%; 
      color: rgb(203, 203, 203); 
      background-color: rgb(30, 29, 26);
    }
    /* Height / width / positioning can be customized for your use case.
       For demo purposes, we make firepad fill the entire browser. */
    .CodeMirror {
      position: absolute; left: 0; top: 34px; bottom: 0; right: 0; height: auto;
      background-color: rgb(30, 29, 26);
      color: rgb(203, 203, 203);
    }

    .CodeMirror div.CodeMirror-cursor{
      border-left: 1px solid white;
    }
    .CodeMirror-gutters{
      background-color: inherit;
      border: inherit;
    }
    .CodeMirror-linenumber{
      color: #808080;
    }

    #filter {
      height: 23px; width: 400px; margin: 2px; border: 2px solid #222; background-color: #333;
      color: inherit;
    }

    #top {
      position: absolute; left: 0px; top: 0px; width: 100%; height: auto;
    }
    .CodeMirror-linewidget{
      overflow-y: hidden;
    }
    .submitIdeaButton {
        border: 0px outset rgb(59, 57, 57);
        /* background-color: rgb(29, 19, 19); */
        color: rgb(62, 62, 62);
        text-decoration: none;
        padding: 0 4px;
        overflow
        /*margin:  0 5px;*/
    }


    .CodeMirror {border-top: 0px solid black; border-bottom: 0px solid black;}
    #upvote {margin-left: 4px; border: 3px #999 solid; background-color: #ddd; padding: 7px;}

    /*.cm-tab { text-indent: initial;}*/
    .CodeMirror pre > * { text-indent: 0px; }

  </style>
</head>

<body>
  <div id="top">
    <input type="text" id="filter" placeholder="Filter (does nothing yet)" />
  </div>
  <textarea id="thoughts" name="code" ></textarea>

  <script id="script">

var cm = null; 
var htmlNode = null;
var submitWidget = null;
window.onload = function() {
  
  var thoughts = document.getElementById("thoughts");
  thoughts.value = "#hashtag @suggestionbox ~person http://imreallyawesome.com\n<>related_idea or rather more like <>related_idea <-- markText atomic: true \n\n\nNew ideas are separated by two blank lines!\n\n\nnew idea with alternating bgcolor!!!\n   \n   \nnotice that the two lines above have spaces, still counts as blank\n\n#newidea if it starts with a #hashtag, one blank line is sufficient\n\n@nuhacks hack the planet\n\nattached to this line a line widget! hr! block element!   \n\n\n\nbelow this is an h1, the lines below it make room for its height\nnotice that the cursor skips over it when you move it with arrow keys\n\n\n\n\nHIERARCHICAL Thoughtstreaming\n\tIDEA: Hm. The hierarchical note taking tool: what if it doesn't submit all ideas, but just hash-tagged ideas? \n\t\tSOCRATES: Why would I ever want to not submit ideas to the database?\n\t\tALT-IDEA: Submit everything, then filter during the search process (i.e. hash-tag only)\n\t\t\tREFUTE: We want to lower the memory demands.\n\t\t\t\tREFUTE: ideas take up like no space it's fine; submit everything b/c we want to be able to do more powerful search.\n\tJustify\n\t\tOBSERVATION: I just started a debate in my notes. \n\t\tIDEA: What if I worked justify-like language into the thoughtstreamer? \n\t\t\tREFUTE: It will get confusing.\n\t\tIDEA: socratesbot automatically auto-fills questions to ask myself, based on context clues.\n\t\t\tSOCRATES: What clues?\n\t\t\t\tHYPOTHESIS: I don't know yet, I'd have to test out taking notes like this until clear patterns emerge which have clear needs. \n\tClear patterns emerging which have clear needs. \n\t\tKeyboard Poweruser Flow\n\t\t\tI should be able to do everything without lifting my hands off the keys\n\t\t\tKey commands for everything, including all GUI interactions.  \n\t\tHierarchies. SUPER definitely. \n\t\t\tWhat if I want one element of the hierarchy to include multiple lines? \n\t\t\t\tI could just have each line be a child, and the parent shall title the whole element.\n\t\t\t\t\tREFUTE: Sometimes I don't want that. \n\t\t\t\t\t\tWhen? \n\t\t\t\t\t\t\tWhen copying text from article. \n\t\t\t\t\t\t\tWhen writing narrative/story/blog\n\t\t\t\t\t\t\tWhen making visual diagram where the whole thing needs to be connected. \n\t\t\t\t\t\t\t\tASCII art\n\t\t\t\t\t\t\t\tTables\n\t\t\t\t\t\t\tWhen I don't want an arbitrary line in the middle to have children\n\t\t\t\t\t\t\tWhen I want to write an email, submit an idea, or execute a command with multiple lines. \n\t\t\t\tDo I use two kinds of line breaks? \n\t\t\t\t\tDifferent ASCII characters?\n\t\t\t\t\t\t\\r is new element\n\t\t\t\t\t\t\\n means new line with existing element\n\t\t\t\tEnter to make new element, shift+enter to add new line to existing element\n\t\tLinks. \n\t\t\tMaking a link\n\t\t\t\t1. Highlight text, key command. \n\t\t\t\t2. Search for idea (or filter) to connect.\n\t\t\tClicking a link\n\t\tNumbered lists\n\t\t\tIf all siblings under a parent start with \"#. \", and any of the numbers are out of order, it will automatically fix the order. The text is altered with deletion/insertion.  \n\tAwesome CodeMirror functions\n\t\tmarkText\n\t\t\tatomic: true\n\t\t\t\tTREAT a block of text as a single object. Can't be edited in the middle. Deleted all at once. \n\t\t\treadOnly: true\n\t\t\t\tThe text can't be destroyed! Resets the history, too. \n\t\t\t\tTHIS would be helpful for PUBLIC-commenting. \n\tOMG i already want to be using my thoughtstream tool and not SUBLIME text anymore\n";

  cm = CodeMirror.fromTextArea(thoughts, {
    mode: "xn",
    /*theme: "monokai",*/
    lineNumbers: true,
    lineWrapping: true,
    foldGutter: true,
    lineWrapping: true,
    smartIndent: true,
    autoFocus: true,
    indentWithTabs: true,
    tabsize: 4,
    /*workTime: 1,
    workDelay: 1,
    pollInterval: 10,
    historyEventDelay: 10,*/
    //cursorHeight: 0.75, /* changed because of line padding */
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
      "Ctrl-W": function(cm){ 
            cm.operation(function() {
              for (var i = cm.firstLine(), e = cm.lastLine(); i <= e; i++)
                cm.foldCode(CodeMirror.Pos(i, 0), null, "fold");
            });
       }
    }
  });

  

  buttonNode = document.createElement("span");
  buttonNode.className = "submitIdeaButton";
  buttonNode.appendChild(document.createTextNode(" test "));

  //submitWidget = null; 
  cm.on("cursorActivity", function(line, changeObjb){
    if(submitWidget) submitWidget.clear();
    var lineCh = cm.getCursor("head")
    var lineNum = lineCh.line;
    var lineObj = cm.getLineHandle(lineNum);
    var bgc = lineObj.styleClasses.bgClass; 
    console.log(lineNum, bgc);

    /*
    if(bgc.substring(0,13)=="xn-empty-line"){
      // this is an empty line. 
      nextLine = cm.getLineHandle(lineNum+1);
      if(!nextLine){
        // we're at the very end white space, no idea here
        return;
      }else if(nextLine && nextLine.styleClasses.bgClass.substring(0,13)=="xn-empty-line"){
        // we're in between ideas, no idea here
        return;
      }
    }
    while( lineNum < cm.lineCount()){ // find the bottom of this idea
      lineNum++;
      lineObj = cm.getLineHandle(lineNum);
      if(!lineObj){
        lineNum--;
        break; // no more lines, we're at the bottom of the document (and the idea)
      }
      bgc = lineObj.styleClasses.bgClass; 
      if(bgc.substring(0,10)=="xn-newidea"){
        // we landed on a new idea, now we back up through the white space until we land on text again
        lineNum--;
        while( lineNum >= 0){
          lineObj = cm.getLineHandle(lineNum);
          bgc = lineObj.styleClasses.bgClass; 
          if(bgc.substring(0,14) == "xn-currentidea"){
            // aha! here's the line. 
            break; 
          }else{
            lineNum--; // back up another line
            continue;
          }
        }
        break;
      }else{
        lineNum++;
        continue; // the bottom of the idea, maybe! 
      }
    }*/

    //submitWidget = cm.addLineWidget(lineNum,buttonNode, {showIfHidden: true })
  })



  //codemirror.net/demo/indentwrap.html
  var charWidth = cm.defaultCharWidth(), basePadding = 4;
  
  cm.on("renderLine", function(cm, line, elt) {
    var column = CodeMirror.countColumn(line.text, null, cm.getOption("tabSize"));
    var off = column * charWidth;
    var lineNumber = cm.getLineNumber(line);
    var bgc = line.styleClasses.bgClass;

    var nextLine = cm.getLineHandle(lineNumber+1);

    //cm.addLineWidget(lineNumber,buttonNode, {showIfHidden: true})
    /*
    if(nextLine && nextLine.hasOwnProperty("styleClasses")){
      var nbgc = nextLine.styleClasses.bgClass;
      //console.log("render", line, elt);
      if(bgc == "xn-empty-line"){
        elt.style.backgroundColor = "red"
      }else  if(bgc == "xn-empty-line-2"){
        elt.style.backgroundColor = "blue"
      }else if(bgc == "xn-newidea-line"){
        elt.style.backgroundColor = "green"

      }else if(bgc == "xn-currentidea-line"){
        elt.style.backgroundColor = "#0f0"
      }
      if(bgc == "xn-empty-line" && nbgc == "xn-empty-line-2"){
        elt.style.backgroundColor = "blue"
      }else if(bgc == "xn-empty-line" && nbgc == "xn-newidea-line" ){
        elt.style.backgroundColor = "blue"
      }
    }*/

    elt.style.textIndent = "-" + off + "px";
    elt.style.paddingLeft = (basePadding + off) + "px";
    /* color unique ideas */
    //elt.style.backgroundColor = "#eee"


    //elt.style.paddingBottom = "5px" /* padding space between lines, so as to distinguish new lines from wrapped text */ 

    /* alternating colored lines vertically / horizontally 
    if (parseInt(column) % 8 == 0){
      if( cm.getLineNumber(line) % 2 == 0){
        bg = "rgb(255,255,255)" 
      }else{
        bg = "rgb(248,248,248)"
      }
    }else{
      if( lineNumber % 2 == 0){
        bg = "rgb(210,210,210)" 
      }else{
        bg = "rgb(222,222,222)"
      }
    }

    elt.style.backgroundImage = "linear-gradient(to right, rgb(255, 255, 255) 0px, rgb(255, 255, 255) "+off+"px, "+bg+" 0%, rgb(255, 255, 255) 100%)"
    //elt.style.backgroundImage = "linear-gradient(to right, rgb(255, 255, 255) 0px, rgb(255, 255, 255) "+off+"px, "+bg+" 0%, rgb(255, 255, 255) 100%)"
    //*/
  });
  cm.refresh();


  // create a node
  htmlNode =document.createElement("h1");
  text =  document.createTextNode("idea overflow 4eva");
  htmlNode.appendChild(text)
  hrNode = document.createElement("hr")


  divNode =document.createElement("div");
  link = document.createElement("a");
  link.id = "upvote";
  link.href = "#";
  link.appendChild(document.createTextNode("upvote"));
  divNode.appendChild(link)


  // call this after you initialized the editor.
  // the position must be like this {ch: YourCharecterNumber, line: YourLineNumber}
  //cm.addLineWidget(6,htmlNode, {showIfHidden: true})
  cm.addLineWidget(15,hrNode, {showIfHidden: true})
  //cm.addLineWidget(11,divNode, {showIfHidden: true})

  // [related idea span]

  relatedIdeaNode =document.createElement("span");
  relatedIdeaNode .className = "relatedIdeaNode";
  relatedIdeaNode.appendChild(document.createTextNode("<>related idea"));
  cm.markText({line:1,ch:35},{line:1,ch:49},{replacedWith:relatedIdeaNode, atomic: true})
  


  //cm.replacedWith()


  $(".CodeMirror").on("click",".cm-xn-hashtag, .cm-xn-persontag, .cm-xn-maptag ",function(e){
    var tagText = e.currentTarget.innerHTML;
    $("#filter").val(tagText)
  })
  $(".CodeMirror").on("click",".cm-xn-link ",function(e){
    var url = e.currentTarget.innerHTML.trim()
    window.open(url)
  })
};





  </script>
</body>